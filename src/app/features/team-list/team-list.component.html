<div class="flex justify-between items-center mb-6">
  <h2 class="text-2xl font-bold text-gray-800">Les acteurs du chantier</h2>
  <button 
    (click)="openAddMemberModal()"
    class="flex items-center px-5 py-2 bg-orange-500 text-white rounded-full shadow-sm hover:bg-orange-600 transition-colors">
    <span class="mr-2 text-xl">+</span>
    <span>Ajouter un membre</span>
  </button>
</div>

<p class="mb-4 text-gray-600">
  Cette section présente l'ensemble des acteurs impliqués dans le chantier, leurs rôles et leurs responsabilités.
</p>

<!-- Message d'erreur -->
<div *ngIf="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
  <p>{{ error }}</p>
  <button 
    (click)="refresh()"
    class="mt-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
    Réessayer
  </button>
</div>

<div class="container mx-auto p-4">
  <!-- Tableau d'équipe -->
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <!-- En-tête du tableau -->
    <div class="grid grid-cols-5 gap-4 px-6 py-4 border-b bg-gray-50">
      <div class="font-semibold text-gray-700">Nom</div>
      <div class="font-semibold text-gray-700">Rôle</div>
      <div class="font-semibold text-gray-700">Téléphone</div>
      <div class="font-semibold text-gray-700">Email</div>
      <div class="font-semibold text-gray-700 text-center">Actif</div>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="px-6 py-8 text-center">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
      <p class="mt-2 text-gray-600">Chargement en cours...</p>
    </div>

    <!-- Lignes du tableau -->
    <div *ngIf="!isLoading" class="min-h-[400px]">
      <div 
        *ngFor="let member of teamMembers"
        class="grid grid-cols-5 gap-4 px-6 py-4 border-b items-center hover:bg-gray-50 transition-colors">
        
        <!-- Colonne Nom avec avatar -->
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-200">
            <img 
              [src]="member.avatar" 
              [alt]="member.name" 
              class="w-full h-full object-cover"
              (error)="$any($event.target).src = 'assets/images/av1.svg'">
          </div>
          <span class="font-medium text-gray-900 truncate">{{ member.name }}</span>
        </div>
        
        <!-- Colonne Rôle -->
        <div class="text-gray-700">
          <span class="inline-block px-3 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
            Ouvrier
          </span>
        </div>
        
        <!-- Colonne Téléphone --> 
        <div class="text-gray-700">
          <a 
            [href]="'tel:' + member.telephone" 
            class="hover:text-orange-600 hover:underline transition-colors">
            {{ member.telephone }}
          </a>
        </div>
        
        <!-- Colonne Email -->
        <div class="text-gray-700 truncate">
          <a 
            [href]="'mailto:' + member.email" 
            class="hover:text-orange-600 hover:underline transition-colors">
            {{ member.email }}
          </a>
        </div>
        
        <!-- Colonne Actif (Oui/Non) -->
        <div class="flex justify-center">
          <span [class]="getPresentClass(member.present)">
            {{ getPresentText(member.present) }}
          </span>
        </div>
      </div>

      <!-- Message si aucun membre -->
      <div 
        *ngIf="teamMembers.length === 0 && !isLoading" 
        class="px-6 py-12 text-center text-gray-500">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
          </path>
        </svg>
        <p class="text-lg font-medium">Aucun membre d'équipe trouvé</p>
        <p class="mt-1 text-sm">Commencez par ajouter des membres à votre équipe</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-4 flex items-center justify-between border-t bg-gray-50">
      <span class="text-sm text-gray-600">{{ getPaginationText() }}</span>
      <div class="flex items-center space-x-2">
        <!-- Bouton précédent -->
        <button 
          *ngIf="hasPreviousPage()" 
          (click)="previousPage()"
          class="px-4 py-2 rounded-lg hover:bg-gray-100 text-orange-500 font-medium flex items-center gap-2 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Précédent
        </button>

        <!-- Numéros de page -->
        <button 
          *ngFor="let page of getPageNumbers()" 
          (click)="goToPage(page)"
          [class]="page === currentPage ? 
            'w-10 h-10 rounded-lg bg-orange-500 text-white font-semibold flex items-center justify-center shadow-sm' : 
            'w-10 h-10 rounded-lg hover:bg-gray-100 text-gray-600 font-medium flex items-center justify-center transition-colors'">
          {{ page + 1 }}
        </button>

        <!-- Bouton suivant -->
        <button 
          *ngIf="hasNextPage()" 
          (click)="nextPage()"
          class="px-4 py-2 rounded-lg hover:bg-gray-100 text-orange-500 font-medium flex items-center gap-2 transition-colors">
          Suivant
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal d'ajout de membre -->
<div 
  *ngIf="showAddMemberModal" 
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
  (click)="onBackdropClick($event)">

  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <!-- Modal Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-800">Ajouter un nouveau membre</h2>
      <button 
        (click)="closeAddMemberModal()" 
        class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="p-6 space-y-4">
      <!-- Messages d'erreur/succès -->
      <div 
        *ngIf="submitError" 
        class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        {{ submitError }}
      </div>

      <div 
        *ngIf="submitSuccess" 
        class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
        {{ submitSuccess }}
      </div>

      <!-- Formulaire d'ajout -->
      <form (ngSubmit)="submitAddMember()" #addMemberForm="ngForm">
        <!-- Nom et Prénom -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="nom" class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
            <input 
              type="text" 
              id="nom" 
              [(ngModel)]="newMember.nom" 
              name="nom" 
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Nom">
          </div>
          <div>
            <label for="prenom" class="block text-sm font-medium text-gray-700 mb-2">Prénom *</label>
            <input 
              type="text" 
              id="prenom" 
              [(ngModel)]="newMember.prenom" 
              name="prenom" 
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Prénom">
          </div>
        </div>

        <!-- Email et Téléphone -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
            <input 
              type="email" 
              id="email" 
              [(ngModel)]="newMember.email" 
              name="email" 
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="email@exemple.com">
          </div>
          <div>
            <label for="telephone" class="block text-sm font-medium text-gray-700 mb-2">Téléphone *</label>
            <input 
              type="tel" 
              id="telephone" 
              [(ngModel)]="newMember.telephone" 
              name="telephone" 
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="77 123 45 67">
          </div>
        </div>

        <!-- Date de naissance et Lieu de naissance -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Date de naissance *</label>
            <input 
              type="date" 
              id="date" 
              [(ngModel)]="newMember.date" 
              name="date" 
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
          </div>
          <div>
            <label for="lieunaissance" class="block text-sm font-medium text-gray-700 mb-2">Lieu de naissance *</label>
            <input 
              type="text" 
              id="lieunaissance" 
              [(ngModel)]="newMember.lieunaissance" 
              name="lieunaissance" 
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Ville de naissance">
          </div>
        </div>

        <!-- Adresse -->
        <div class="mb-4">
          <label for="adress" class="block text-sm font-medium text-gray-700 mb-2">Adresse *</label>
          <input 
            type="text" 
            id="adress" 
            [(ngModel)]="newMember.adress" 
            name="adress" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            placeholder="Adresse complète">
        </div>

        <!-- Photo (optionnelle) -->
        <div class="mb-4">
          <label for="photo" class="block text-sm font-medium text-gray-700 mb-2">Photo de profil</label>
          
          <!-- Zone d'upload -->
          <div class="flex items-start gap-4">
            <!-- Aperçu de la photo -->
            <div *ngIf="photoPreview" class="flex-shrink-0">
              <div class="relative w-24 h-24 rounded-lg overflow-hidden border-2 border-gray-200">
                <img [src]="photoPreview" alt="Aperçu" class="w-full h-full object-cover">
                <button 
                  type="button" 
                  (click)="removePhoto()"
                  class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Input file -->
            <div class="flex-1">
              <input 
                type="file" 
                id="photo" 
                name="photo" 
                accept="image/*" 
                (change)="onPhotoSelected($event)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
              <p class="mt-1 text-xs text-gray-500">Formats acceptés : JPG, PNG, GIF (Max 5MB)</p>
            </div>
          </div>
        </div>

        <!-- Mot de passe -->
        <div class="mb-6">
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Mot de passe *</label>
          <input 
            type="password" 
            id="password" 
            [(ngModel)]="newMember.password" 
            name="password" 
            required 
            minlength="6"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            placeholder="Mot de passe (minimum 6 caractères)">
        </div>

        <!-- Actions du formulaire -->
        <div class="flex justify-end gap-3 pt-4 border-t">
          <button 
            type="button" 
            (click)="closeAddMemberModal()"
            class="px-6 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
            Annuler
          </button>
          <button 
            type="submit" 
            [disabled]="isSubmitting"
            class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            <span *ngIf="isSubmitting" class="flex items-center gap-2">
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>
              Ajout...
            </span>
            <span *ngIf="!isSubmitting">Ajouter</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>